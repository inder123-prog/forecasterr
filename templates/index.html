<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Market Forecast Demo</title>
    <style>
        :root {
            --primary: #0d6efd;
            --primary-dark: #0a58ca;
            --border: #d0d7de;
            --background: #f2f5f9;
            --card-bg: #ffffff;
            --text-main: #20263c;
            --text-muted: #5f6b7a;
            --shadow: 0 20px 32px rgba(15, 23, 42, 0.08);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: "Segoe UI", Tahoma, sans-serif;
            margin: 0;
            padding: 24px;
            background: var(--background);
            color: var(--text-main);
        }

        .top-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #0f172a;
            color: #fff;
            padding: 16px 24px;
            border-radius: 18px;
            margin-bottom: 24px;
            box-shadow: 0 16px 28px rgba(15, 23, 42, 0.15);
            border: 1px solid rgba(15, 23, 42, 0.35);
        }

        .top-nav .brand {
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: 0.15rem;
        }

        .top-nav .nav-right {
            display: flex;
            align-items: center;
            gap: 14px;
            font-size: 0.95rem;
        }

        .logout-btn {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: #fff;
            border: none;
            border-radius: 999px;
            padding: 10px 18px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s ease, box-shadow 0.2s ease;
        }

          .nav-link-btn {
              display: inline-flex;
              align-items: center;
              justify-content: center;
              padding: 10px 18px;
              border-radius: 999px;
              font-weight: 600;
              text-decoration: none;
              background: rgba(255, 255, 255, 0.12);
              color: #fff;
              border: 1px solid rgba(255, 255, 255, 0.32);
              transition: transform 0.15s ease, box-shadow 0.2s ease, background 0.2s ease;
          }

          .nav-link-btn:hover {
              transform: translateY(-1px);
              box-shadow: 0 12px 24px rgba(13, 110, 253, 0.3);
              background: rgba(255, 255, 255, 0.22);
          }

        .logout-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(220, 38, 38, 0.3);
        }

        .container {
            background: var(--card-bg);
            border-radius: 18px;
            padding: 32px;
            max-width: 880px;
            margin: auto;
            box-shadow: var(--shadow);
            border: 1px solid rgba(220, 224, 230, 0.6);
        }

        h1 {
            margin-top: 0;
            text-align: center;
            font-size: 2rem;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: var(--text-muted);
            margin-bottom: 28px;
            font-size: 1rem;
        }

        .form-grid {
            display: grid;
            gap: 20px;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            margin-bottom: 10px;
        }

        .field-group {
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .field-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-main);
        }

          .feature-toggle-card {
              margin-top: 20px;
              padding: 18px 20px;
              border-radius: 16px;
              border: 1px solid rgba(210, 220, 235, 0.9);
              background: linear-gradient(135deg, #f9fbff 0%, #eef5ff 100%);
              box-shadow: 0 12px 24px rgba(15, 23, 42, 0.08);
          }

          .feature-toggle-card h3 {
              margin: 0 0 10px;
              font-size: 1.15rem;
              font-weight: 600;
              color: var(--text-main);
          }

          .feature-toggle-subtitle {
              margin: 0 0 18px;
              font-size: 0.9rem;
              color: var(--text-muted);
          }

          .feature-toggle-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
              gap: 14px;
          }

          .feature-toggle {
              display: flex;
              gap: 12px;
              align-items: flex-start;
              padding: 12px 14px;
              border-radius: 14px;
              border: 1px solid rgba(210, 220, 235, 0.7);
              background: rgba(255, 255, 255, 0.85);
              cursor: pointer;
              transition: border-color 0.2s ease, box-shadow 0.2s ease, transform 0.15s ease;
          }

          .feature-toggle:hover {
              border-color: var(--primary);
              box-shadow: 0 14px 26px rgba(13, 110, 253, 0.12);
              transform: translateY(-1px);
          }

          .feature-toggle input[type="checkbox"] {
              margin-top: 4px;
              width: 18px;
              height: 18px;
              accent-color: var(--primary);
              cursor: pointer;
          }

          .feature-toggle .toggle-label {
              font-weight: 600;
              color: var(--text-main);
          }

          .feature-toggle .toggle-description {
              display: block;
              margin-top: 4px;
              font-size: 0.85rem;
              color: var(--text-muted);
          }

        .input-shell {
            position: relative;
            display: flex;
            align-items: center;
            background: #f8fafc;
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
        }

        .input-shell:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.12);
            background: #fff;
        }

        .input-shell input,
        .input-shell select {
            border: none;
            background: transparent;
            width: 100%;
            padding: 12px 14px;
            font-size: 1rem;
            color: var(--text-main);
            outline: none;
        }

        select {
            appearance: none;
        }

        .input-shell select:disabled {
            cursor: not-allowed;
            color: #9ca3af;
        }

        .helper-text {
            margin-top: 8px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        input[type="file"] {
            font-size: 0.95rem;
            color: var(--text-main);
            border: 1px dashed var(--border);
            border-radius: 12px;
            padding: 12px;
            background: #f8fafc;
            transition: border-color 0.2s, background-color 0.2s;
        }

        input[type="file"]:hover {
            border-color: var(--primary);
            background: rgba(13, 110, 253, 0.04);
        }

        button.primary-action {
            background: linear-gradient(135deg, var(--primary), #4c8ffd);
            color: #fff;
            padding: 14px 18px;
            border: none;
            border-radius: 14px;
            cursor: pointer;
            font-size: 1.05rem;
            font-weight: 600;
            letter-spacing: 0.3px;
            transition: transform 0.15s ease, box-shadow 0.2s ease;
            width: 100%;
            margin-top: 10px;
        }

        button.primary-action:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(13, 110, 253, 0.25);
        }

        button.primary-action:active {
            transform: translateY(0);
        }

        .form-message {
            display: none;
            margin: 16px 0 8px;
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid transparent;
            font-weight: 500;
        }

        .form-message.error {
            display: block;
            color: #8b2121;
            background: #ffeaea;
            border-color: #f7c2c2;
        }

        .form-message.info {
            display: block;
            color: #0c5460;
            background: #d1ecf1;
            border-color: #bee5eb;
        }

        .loader {
            border: 5px solid #e2e8f0;
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            animation: spin 1s linear infinite;
            margin: 30px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            margin-top: 30px;
            padding: 24px 26px;
            border-radius: 16px;
            background: #fff;
            border: 1px solid rgba(220, 224, 230, 0.7);
            box-shadow: 0 12px 28px rgba(15, 23, 42, 0.08);
            display: none;
        }

        .results h2 {
            margin-top: 0;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .results section {
            margin-top: 20px;
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            border-left: 4px solid var(--primary);
            padding-left: 10px;
            color: var(--text-main);
        }

        .daily-forecast-day {
            border: 1px solid rgba(221, 226, 233, 0.8);
            padding: 12px 14px;
            border-radius: 12px;
            background: linear-gradient(135deg, #f8fbff 0%, #eef3ff 100%);
            margin-bottom: 12px;
        }

        .daily-forecast-day h4 {
            margin: 0 0 8px;
            color: #2f3c56;
            font-size: 1rem;
        }

        .recommendation {
            font-weight: 700;
            letter-spacing: 0.4px;
        }

        .recommendation.buy { color: #0f9d58; }
        .recommendation.sell { color: #d93025; }
        .recommendation.neutral { color: #f4b400; }

        .highlight-card {
            border: 1px solid rgba(221, 226, 233, 0.9);
            border-radius: 14px;
            padding: 16px 18px;
            background: #f9fbff;
            margin-bottom: 16px;
        }

          .feature-flag-status {
              display: flex;
              flex-direction: column;
              gap: 16px;
          }

          .feature-flag-row {
              display: flex;
              flex-direction: column;
              gap: 6px;
          }

          .feature-flag-row-header {
              display: flex;
              flex-wrap: wrap;
              align-items: center;
              gap: 12px;
          }

          .feature-flag-name {
              font-weight: 600;
              color: var(--text-main);
          }

          .feature-flag-pills {
              display: flex;
              flex-wrap: wrap;
              gap: 8px;
          }

          .feature-flag-chip {
              font-size: 0.8rem;
              font-weight: 600;
              padding: 4px 10px;
              border-radius: 999px;
              border: 1px solid rgba(148, 163, 184, 0.4);
              background: rgba(241, 245, 249, 0.7);
              color: var(--text-muted);
          }

          .feature-flag-chip.on {
              border-color: rgba(34, 197, 94, 0.35);
              background: rgba(34, 197, 94, 0.18);
              color: #0f8a49;
          }

          .feature-flag-chip.off {
              border-color: rgba(239, 68, 68, 0.3);
              background: rgba(239, 68, 68, 0.16);
              color: #c1362f;
          }

          .feature-flag-chip.neutral {
              border-color: rgba(148, 163, 184, 0.4);
              background: rgba(241, 245, 249, 0.7);
              color: var(--text-muted);
          }

          .feature-flag-note {
              font-size: 0.82rem;
              color: var(--text-muted);
              padding-left: 2px;
          }

          .ai-trading-card {
              display: flex;
              flex-direction: column;
              gap: 16px;
          }

          .ai-action-badge {
              align-self: flex-start;
              padding: 6px 14px;
              border-radius: 999px;
              font-weight: 600;
              text-transform: uppercase;
              letter-spacing: 0.6px;
              background: rgba(13, 110, 253, 0.12);
              color: var(--primary);
              border: 1px solid rgba(13, 110, 253, 0.35);
          }

          .ai-action-badge.buy {
              background: rgba(34, 197, 94, 0.18);
              border-color: rgba(34, 197, 94, 0.35);
              color: #0f8a49;
          }

          .ai-action-badge.sell {
              background: rgba(239, 68, 68, 0.18);
              border-color: rgba(239, 68, 68, 0.35);
              color: #c1362f;
          }

          .ai-trading-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
              gap: 12px;
          }

          .ai-trading-metric {
              display: flex;
              flex-direction: column;
              gap: 4px;
              padding: 12px 14px;
              border-radius: 12px;
              border: 1px solid rgba(210, 220, 235, 0.6);
              background: rgba(248, 250, 252, 0.9);
          }

          .ai-trading-metric span {
              font-size: 0.85rem;
              color: var(--text-muted);
          }

          .ai-trading-metric strong {
              font-size: 1rem;
              color: var(--text-main);
          }

          .ai-reasoning-list,
          .ai-backtest-list {
              margin: 0;
              padding-left: 20px;
              color: var(--text-muted);
          }

          .ai-reasoning-list li,
          .ai-backtest-list li {
              margin-bottom: 6px;
          }

          .ai-reasoning-list li strong {
              color: var(--text-main);
          }

          .ai-trading-note {
              font-size: 0.82rem;
              color: var(--text-muted);
              padding-left: 2px;
          }

        .highlight-card ul {
            margin: 12px 0 0 0;
            padding-left: 18px;
        }

        .highlight-card li {
            margin-bottom: 6px;
            color: var(--text-muted);
        }

        .news-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 14px;
        }

        .news-list li {
            border: 1px solid rgba(223, 228, 236, 0.9);
            padding: 14px 16px;
            border-radius: 12px;
            background: #fff;
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.05);
        }

        .news-list a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }

        .news-list a:hover {
            text-decoration: underline;
        }

        .dashboards-section {
            margin-top: 28px;
        }

        .dashboard-grid {
            display: grid;
            gap: 18px;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        }

        .dashboard-card {
            border: 1px solid rgba(210, 220, 235, 0.9);
            border-radius: 16px;
            padding: 18px 20px 20px;
            background: #ffffff;
            box-shadow: 0 16px 28px rgba(15, 23, 42, 0.08);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .dashboard-headline {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 12px;
        }

        .dashboard-title {
            margin: 0;
            font-size: 1.05rem;
            font-weight: 600;
            color: var(--text-main);
        }

        .dashboard-subtitle {
            display: block;
            margin-top: 4px;
            font-size: 0.82rem;
            color: var(--text-muted);
        }

        .dashboard-interval {
            font-size: 0.78rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 999px;
            background: rgba(15, 23, 42, 0.06);
            color: var(--text-main);
            white-space: nowrap;
        }

        .dashboard-price-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .dashboard-price {
            font-size: 1.7rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .dashboard-change {
            font-size: 0.9rem;
            font-weight: 600;
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.16);
            color: var(--text-muted);
            white-space: nowrap;
        }

        .dashboard-change.positive {
            background: rgba(34, 197, 94, 0.14);
            color: #0f8a49;
        }

        .dashboard-change.negative {
            background: rgba(239, 68, 68, 0.14);
            color: #c1362f;
        }

        .dashboard-change.neutral {
            background: rgba(148, 163, 184, 0.16);
            color: var(--text-muted);
        }

        .sparkline {
            width: 100%;
            height: 60px;
            border-radius: 12px;
            background: rgba(241, 245, 249, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .sparkline svg {
            width: 100%;
            height: 100%;
        }

        .sparkline polyline {
            fill: none;
            stroke: var(--primary);
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .dashboard-card.accent-one-day .sparkline polyline {
            stroke: #2dd4bf;
        }

        .dashboard-card.accent-five-day .sparkline polyline {
            stroke: #f97316;
        }

        .dashboard-card.accent-one-month .sparkline polyline {
            stroke: #6366f1;
        }

        .dashboard-card.accent-three-month .sparkline polyline {
            stroke: #ec4899;
        }

        .sparkline.placeholder {
            color: var(--text-muted);
            font-size: 0.82rem;
            background: rgba(241, 245, 249, 0.9);
        }

        .dashboard-metrics {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 16px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .dashboard-metrics strong {
            color: var(--text-main);
        }

        .dashboard-card.accent-live {
            border-top: 4px solid rgba(13, 110, 253, 0.85);
        }

        .dashboard-card.accent-one-day {
            border-top: 4px solid rgba(45, 212, 191, 0.85);
        }

        .dashboard-card.accent-five-day {
            border-top: 4px solid rgba(249, 115, 22, 0.85);
        }

        .dashboard-card.accent-one-month {
            border-top: 4px solid rgba(99, 102, 241, 0.85);
        }

        .dashboard-card.accent-three-month {
            border-top: 4px solid rgba(236, 72, 153, 0.85);
        }

        .forecast-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 10px 22px;
            margin: 12px 0 8px;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        .forecast-meta .meta-item {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .forecast-meta .meta-item strong {
            color: var(--text-main);
        }

        .search-wrapper {
            position: relative;
        }

        .search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: #fff;
            border-radius: 14px;
            border: 1px solid rgba(210, 220, 235, 0.9);
            box-shadow: 0 18px 30px rgba(15, 23, 42, 0.12);
            max-height: 280px;
            overflow-y: auto;
            padding: 6px;
            display: none;
            z-index: 20;
        }

        .search-results.visible {
            display: block;
        }

        .search-result {
            width: 100%;
            border: none;
            background: none;
            text-align: left;
            padding: 10px 12px;
            border-radius: 10px;
            cursor: pointer;
            display: grid;
            row-gap: 2px;
            transition: background 0.15s ease, transform 0.1s ease;
        }

        .search-result:hover,
        .search-result:focus {
            background: rgba(13, 110, 253, 0.08);
            transform: translateY(-1px);
            outline: none;
        }

        .search-result .result-symbol {
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.95rem;
        }

        .search-result .result-name {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .search-result .result-meta {
            color: #94a3b8;
            font-size: 0.8rem;
        }

        .search-result.empty,
        .search-result.error {
            cursor: default;
            background: #f8fafc;
            color: var(--text-muted);
            transform: none;
        }

        .search-result.empty:hover,
        .search-result.error:hover {
            background: #f8fafc;
        }

        @media (max-width: 640px) {
            body {
                padding: 16px;
            }

            .container {
                padding: 24px 20px;
                border-radius: 14px;
            }

            h1 {
                font-size: 1.7rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .top-nav {
                padding: 14px 16px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

              .feature-toggle-grid {
                  grid-template-columns: 1fr;
              }
        }
    </style>
</head>
        <body>
            <div class="top-nav">
                <div class="brand">FORECASTERRR</div>
                <div class="nav-right">
                    <span class="welcome-text">Welcome, {{ username }}!</span>
                      <a class="nav-link-btn" href="{{ url_for('top_tech_portal') }}">Top Tech Leaders</a>
                    <button class="logout-btn" id="logoutBtn" type="button">Logout</button>
                </div>
            </div>
            <div class="container">
                <h1>Market Price Forecast</h1>
                <p class="subtitle">Search by ticker, choose asset type, upload a chart, and explore enriched forecasts for stocks or crypto.</p>

        <div class="form-grid">
            <div class="field-group">
                <label for="companySearch">Search Company</label>
                <div class="input-shell search-wrapper">
                    <input type="text" id="companySearch" name="companySearch" placeholder="Type company name, e.g., Apple" autocomplete="off">
                    <div id="searchResults" class="search-results"></div>
                </div>
                <span class="helper-text">Start typing to see matching companies and tickers.</span>
            </div>

            <div class="field-group">
                <label for="ticker">Selected Ticker</label>
                <div class="input-shell">
                    <input type="text" id="ticker" name="ticker" placeholder="AAPL">
                </div>
                <span class="helper-text">Auto-filled from search, or enter a symbol manually (e.g., AAPL, BTC-USD).</span>
            </div>

            <div class="field-group">
                <label for="assetType">Asset Type</label>
                <div class="input-shell">
                    <select id="assetType" name="assetType">
                        <option value="equity" selected>Equity / ETF</option>
                        <option value="crypto">Crypto</option>
                    </select>
                </div>
                <span class="helper-text">Select crypto to enable 24/7 forecasts (e.g., BTC-USD, ETH-USD).</span>
            </div>

            <div class="field-group">
                <label for="marketCountry">Market (for Holidays)</label>
                <div class="input-shell">
                    <select id="marketCountry" name="marketCountry">
                        <option value="US" selected>United States (US)</option>
                        <option value="CA">Canada (CA)</option>
                        <option value="GB">United Kingdom (GB)</option>
                        <option value="DE">Germany (DE)</option>
                        <option value="IN">India (IN)</option>
                        <option value="CRYPTO">Crypto (Global 24/7)</option>
                    </select>
                </div>
                <span class="helper-text">Used to apply holiday calendars during forecasting (auto-set for crypto).</span>
            </div>

            <div class="field-group">
                <label for="chartImage">Upload Stock Chart (Optional)</label>
                <input type="file" id="chartImage" name="chartImage" accept="image/*">
                <span class="helper-text">Supported formats: PNG, JPG, GIF (max 5 MB recommended).</span>
            </div>
        </div>

          <div class="feature-toggle-card">
              <h3>Feature Flags</h3>
              <p class="feature-toggle-subtitle">Toggle optional enrichment signals before generating your forecast.</p>
                <div class="feature-toggle-grid">
                    <label class="feature-toggle">
                        <input type="checkbox" id="toggleMacro" checked>
                        <div>
                            <span class="toggle-label">Macro Data</span>
                            <span class="toggle-description">Blend FRED macro indicators into the Prophet model.</span>
                        </div>
                    </label>
                    <label class="feature-toggle">
                        <input type="checkbox" id="toggleNews" checked>
                        <div>
                            <span class="toggle-label">News Sentiment</span>
                            <span class="toggle-description">Aggregate recent headlines and sentiment buckets.</span>
                        </div>
                    </label>
                    <label class="feature-toggle">
                        <input type="checkbox" id="toggleFundamental" checked>
                        <div>
                            <span class="toggle-label">Fundamental Metrics</span>
                            <span class="toggle-description">Inject valuation ratios and quarterly trends from filings.</span>
                        </div>
                    </label>
                    <label class="feature-toggle">
                        <input type="checkbox" id="toggleCandlestick" checked>
                        <div>
                            <span class="toggle-label">Candlestick Patterns</span>
                            <span class="toggle-description">Score recent OHLC data for bullish/bearish signals.</span>
                        </div>
                    </label>
                </div>
          </div>

        <div id="formMessage" class="form-message"></div>

        <button class="primary-action" onclick="getForecast()">Generate Forecast</button>

        <div class="loader" id="loader"></div>
        <div id="forecastResult" class="results">
            <!-- Results will be injected here -->
        </div>
    </div>

    <script>
        const searchResultsContainer = document.getElementById('searchResults');
        const companySearchInput = document.getElementById('companySearch');
        const tickerInput = document.getElementById('ticker');
        const formMessage = document.getElementById('formMessage');
        const resultDiv = document.getElementById('forecastResult');
        const loader = document.getElementById('loader');
        const assetTypeSelect = document.getElementById('assetType');
        const marketCountrySelect = document.getElementById('marketCountry');
          const toggleMacro = document.getElementById('toggleMacro');
          const toggleNews = document.getElementById('toggleNews');
          const toggleFundamental = document.getElementById('toggleFundamental');
          const toggleCandlestick = document.getElementById('toggleCandlestick');
        const logoutBtn = document.getElementById('logoutBtn');
        let searchDebounceId = null;
        let latestSearchTerm = '';

        if (logoutBtn) {
            logoutBtn.addEventListener('click', handleLogout);
        }

        companySearchInput.addEventListener('input', handleCompanySearch);
        companySearchInput.addEventListener('focus', () => {
            if (searchResultsContainer.childElementCount > 0) {
                searchResultsContainer.classList.add('visible');
            }
        });

        document.addEventListener('click', (event) => {
            if (!searchResultsContainer.contains(event.target) && event.target !== companySearchInput) {
                clearSearchResults();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                clearSearchResults();
                companySearchInput.blur();
            }
        });

        function syncMarketSelector(assetType) {
            if (!marketCountrySelect) {
                return;
            }
            if ((assetType || '').toLowerCase() === 'crypto') {
                marketCountrySelect.value = 'CRYPTO';
                marketCountrySelect.disabled = true;
            } else {
                marketCountrySelect.disabled = false;
                if (marketCountrySelect.value === 'CRYPTO') {
                    marketCountrySelect.value = 'US';
                }
            }
        }

        syncMarketSelector(assetTypeSelect.value);
        assetTypeSelect.addEventListener('change', (event) => {
            syncMarketSelector(event.target.value);
        });

        function handleCompanySearch(event) {
            clearFormMessage();
            const query = event.target.value.trim();
            if (searchDebounceId) {
                clearTimeout(searchDebounceId);
            }
            if (query.length === 0) {
                tickerInput.value = '';
                clearSearchResults();
                return;
            }
            if (query.length < 2) {
                clearSearchResults();
                return;
            }
            searchDebounceId = setTimeout(() => fetchCompanyMatches(query), 250);
        }

        async function fetchCompanyMatches(query) {
            latestSearchTerm = query;
            searchResultsContainer.innerHTML = '';
            const loadingRow = document.createElement('div');
            loadingRow.className = 'search-result empty';
            loadingRow.textContent = 'Searching...';
            searchResultsContainer.appendChild(loadingRow);
            searchResultsContainer.classList.add('visible');

            try {
                const response = await fetch(`/company_search?q=${encodeURIComponent(query)}`);
                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }
                if (!response.ok) {
                    throw new Error('Search request failed');
                }
                const data = await response.json();
                if (latestSearchTerm !== query) {
                    return;
                }
                renderSearchResults(Array.isArray(data.results) ? data.results : []);
            } catch (error) {
                if (latestSearchTerm !== query) {
                    return;
                }
                searchResultsContainer.innerHTML = '';
                const errorRow = document.createElement('div');
                errorRow.className = 'search-result error';
                errorRow.textContent = 'Unable to fetch suggestions right now.';
                searchResultsContainer.appendChild(errorRow);
                searchResultsContainer.classList.add('visible');
                console.error('Company search error:', error);
            }
        }

        function renderSearchResults(results) {
            searchResultsContainer.innerHTML = '';
            if (!results.length) {
                const emptyRow = document.createElement('div');
                emptyRow.className = 'search-result empty';
                emptyRow.textContent = 'No matching companies found.';
                searchResultsContainer.appendChild(emptyRow);
                searchResultsContainer.classList.add('visible');
                return;
            }

            results.forEach((result) => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'search-result';
                const symbol = result.symbol || '';
                const name = result.name || symbol;
                const metaParts = [result.exchange, result.assetType, result.sector].filter(Boolean);

                button.innerHTML = `
                    <span class="result-symbol">${symbol}</span>
                    <span class="result-name">${name}</span>
                    <span class="result-meta">${metaParts.join(' • ')}</span>
                `;
                button.addEventListener('click', () => selectCompanyResult(result));
                searchResultsContainer.appendChild(button);
            });

            searchResultsContainer.classList.add('visible');
        }

        function selectCompanyResult(result) {
            const symbol = (result.symbol || '').toUpperCase();
            const displayName = result.name ? `${result.name} (${symbol})` : symbol;
            companySearchInput.value = displayName;
            tickerInput.value = symbol;
            clearSearchResults();
        }

        function clearSearchResults() {
            searchResultsContainer.innerHTML = '';
            searchResultsContainer.classList.remove('visible');
        }

        function showFormMessage(message, type = 'error') {
            if (!message) {
                formMessage.style.display = 'none';
                formMessage.textContent = '';
                formMessage.className = 'form-message';
                return;
            }
            formMessage.textContent = message;
            formMessage.className = `form-message ${type}`;
            formMessage.style.display = 'block';
        }

        function clearFormMessage() {
            showFormMessage('');
        }

        function getCurrencySymbol() {
            if (assetTypeSelect && assetTypeSelect.value && assetTypeSelect.value.toLowerCase() === 'crypto') {
                return '';
            }
            const marketValue = marketCountrySelect && marketCountrySelect.value
                ? marketCountrySelect.value.toUpperCase()
                : '';
            const symbolMap = {
                'IN': '₹',
                'GB': '£',
                'UK': '£',
                'CA': 'C$',
                'DE': '€',
                'US': '$'
            };
            return symbolMap[marketValue] || '$';
        }

        function displayValue(value, prefix, suffix = '') {
            if (value === null || value === undefined || value === 'N/A' || value === 'undefined') {
                return 'N/A';
            }
            const resolvedPrefix = prefix !== undefined ? prefix : getCurrencySymbol();
            return `${resolvedPrefix || ''}${value}${suffix}`;
        }

        function formatMetric(value, decimals = 2) {
            if (value === null || value === undefined || value === 'N/A' || Number.isNaN(Number(value))) {
                return 'N/A';
            }
            const numericValue = Number(value);
            return numericValue.toLocaleString(undefined, {
                minimumFractionDigits: 0,
                maximumFractionDigits: decimals
            });
        }

        function formatPercentFromDecimal(value, decimals = 2) {
            if (value === null || value === undefined || value === 'N/A' || Number.isNaN(Number(value))) {
                return 'N/A';
            }
            const numericValue = Number(value) * 100;
            return `${numericValue.toFixed(decimals)}%`;
        }

          function formatOptionalPercent(value, decimals = 2) {
              if (value === null || value === undefined || Number.isNaN(Number(value))) {
                  return 'N/A';
              }
              return formatPercentFromDecimal(Number(value), decimals);
          }

        function formatLabel(label) {
            return label
                .replace(/_/g, ' ')
                .replace(/\b\w/g, (char) => char.toUpperCase());
        }

        function formatDateTime(value) {
            if (!value) {
                return 'N/A';
            }
            try {
                const date = new Date(value);
                if (Number.isNaN(date.getTime())) {
                    return value;
                }
                return date.toLocaleString();
            } catch (error) {
                return value;
            }
        }

        const FEATURE_FLAG_LABELS = {
            macro: 'Macro Data',
            news: 'News Sentiment',
            fundamental: 'Fundamental Metrics',
            candlestick: 'Candlestick Patterns'
        };

          const DASHBOARD_CONFIG = [
            { key: 'live', title: 'Live Overview', description: 'Intraday pulse and latest move', accent: 'accent-live' },
            { key: 'one_day', title: '1 Day Session', description: 'Full trading day momentum', accent: 'accent-one-day' },
            { key: 'five_day', title: '5 Day Trend', description: 'Rolling workweek performance', accent: 'accent-five-day' },
            { key: 'one_month', title: '1 Month Momentum', description: 'Medium-term movement', accent: 'accent-one-month' },
            { key: 'three_month', title: '3 Month Trajectory', description: 'Quarterly trajectory', accent: 'accent-three-month' }
        ];

        function formatIntervalLabel(interval) {
            if (!interval || typeof interval !== 'string') {
                return '';
            }
            const normalized = interval.toLowerCase();
            const mapping = {
                '1m': '1 min',
                '2m': '2 min',
                '5m': '5 min',
                '15m': '15 min',
                '30m': '30 min',
                '60m': 'Hourly',
                '1h': 'Hourly',
                '1d': 'Daily',
                '5d': '5 Day',
                '1wk': 'Weekly',
                '1mo': 'Monthly'
            };
            return mapping[normalized] || interval;
        }

        function renderChangePill(changeValue, changePercent) {
            if (changeValue === null || changeValue === undefined || Number.isNaN(Number(changeValue))) {
                return '<span class="dashboard-change neutral">N/A</span>';
            }
            const numericChange = Number(changeValue);
            const direction = numericChange > 0 ? 'positive' : numericChange < 0 ? 'negative' : 'neutral';
            const absChange = Math.abs(numericChange);
            const changeText = formatMetric(absChange, 2);

            let percentText = '';
            if (changePercent !== null && changePercent !== undefined && !Number.isNaN(Number(changePercent))) {
                const absPercent = Math.abs(Number(changePercent));
                const signPercent = numericChange > 0 ? '+' : numericChange < 0 ? '-' : '';
                percentText = ` (${signPercent}${absPercent.toFixed(2)}%)`;
            }

            const signSymbol = numericChange > 0 ? '+' : numericChange < 0 ? '-' : '';
            return `<span class="dashboard-change ${direction}">${signSymbol}${changeText}${percentText}</span>`;
        }

        function renderSparkline(series) {
            if (!Array.isArray(series) || series.length < 2) {
                return '<div class="sparkline placeholder">Trend data unavailable</div>';
            }
            const sanitized = series
                .map(point => ({
                    price: Number(point.price),
                    time: point.time
                }))
                .filter(point => !Number.isNaN(point.price));

            if (sanitized.length < 2) {
                return '<div class="sparkline placeholder">Trend data unavailable</div>';
            }

            const values = sanitized.map(point => point.price);
            const min = Math.min(...values);
            const max = Math.max(...values);
            const range = max - min;
            const lastIndex = sanitized.length - 1;

            const points = sanitized.map((point, index) => {
                const x = lastIndex === 0 ? 0 : (index / lastIndex) * 100;
                const y = range === 0 ? 50 : 100 - ((point.price - min) / range) * 100;
                return `${x.toFixed(2)},${y.toFixed(2)}`;
            }).join(' ');

            return `
                <div class="sparkline" role="presentation" aria-hidden="true">
                    <svg viewBox="0 0 100 100" preserveAspectRatio="none">
                        <polyline points="${points}" />
                    </svg>
                </div>
            `;
        }

        function renderDashboards(dashboards) {
            if (!dashboards || typeof dashboards !== 'object') {
                return '';
            }

            let cardsHtml = '';
            DASHBOARD_CONFIG.forEach(config => {
                const snapshot = dashboards[config.key];
                if (!snapshot) {
                    return;
                }

                const intervalLabel = snapshot.interval ? formatIntervalLabel(snapshot.interval) : '';
                const sparklineHtml = renderSparkline(snapshot.series);
                const metrics = [
                    `<span><strong>High:</strong> ${displayValue(snapshot.high)}</span>`,
                    `<span><strong>Low:</strong> ${displayValue(snapshot.low)}</span>`
                ];

                if (config.key === 'live' && snapshot.previous_close !== undefined && snapshot.previous_close !== null) {
                    metrics.push(`<span><strong>Prev Close:</strong> ${displayValue(snapshot.previous_close)}</span>`);
                }

                if (snapshot.volume !== undefined && snapshot.volume !== null && !Number.isNaN(Number(snapshot.volume))) {
                    metrics.push(`<span><strong>Volume:</strong> ${formatMetric(snapshot.volume, 0)}</span>`);
                }

                cardsHtml += `
                    <div class="dashboard-card ${config.accent}">
                        <div class="dashboard-headline">
                            <div>
                                <h4 class="dashboard-title">${config.title}</h4>
                                <span class="dashboard-subtitle">${config.description}</span>
                            </div>
                            ${intervalLabel ? `<span class="dashboard-interval">${intervalLabel}</span>` : ''}
                        </div>
                        <div class="dashboard-price-row">
                            <span class="dashboard-price">${displayValue(snapshot.latest_price)}</span>
                            ${renderChangePill(snapshot.price_change, snapshot.price_change_percent)}
                        </div>
                        ${sparklineHtml}
                        <div class="dashboard-metrics">
                            ${metrics.join('')}
                        </div>
                    </div>
                `;
            });

            if (!cardsHtml.trim()) {
                return '';
            }

            return `
                <section class="dashboards-section">
                    <h3 class="section-title">Market Dashboards</h3>
                    <div class="dashboard-grid">
                        ${cardsHtml}
                    </div>
                </section>
            `;
        }

          function renderAITradingSection(aiTrading) {
              if (!aiTrading || typeof aiTrading !== 'object') {
                  return '';
              }

              if ((aiTrading.status || '').toLowerCase() !== 'ready') {
                  const reason = aiTrading.reason || 'AI trading insights are unavailable for this request.';
                  return `
                      <section>
                          <h3 class="section-title">AI Trading Strategy</h3>
                          <div class="highlight-card">
                              <p class="helper-text">${reason}</p>
                          </div>
                      </section>
                  `;
              }

              const signal = aiTrading.latest_signal || {};
              const actionRaw = (signal.action || 'hold').toLowerCase();
              const actionLabel = formatLabel(signal.action || 'hold');
              const probabilityUp = formatOptionalPercent(signal.probability_up, 1);
              const probabilityDown = formatOptionalPercent(signal.probability_down, 1);
              const confidence = formatOptionalPercent(signal.confidence, 1);
              const expectedReturn = formatOptionalPercent(signal.expected_daily_return, 2);
              const positionSize = signal.position_size_fraction !== undefined && signal.position_size_fraction !== null
                  ? formatOptionalPercent(signal.position_size_fraction, 1)
                  : 'N/A';
              const stopLoss = signal.stop_loss !== undefined && signal.stop_loss !== null && !Number.isNaN(Number(signal.stop_loss))
                  ? displayValue(Number(signal.stop_loss))
                  : 'N/A';
              const takeProfit = signal.take_profit !== undefined && signal.take_profit !== null && !Number.isNaN(Number(signal.take_profit))
                  ? displayValue(Number(signal.take_profit))
                  : 'N/A';
              const atrValue = signal.atr_14 !== undefined && signal.atr_14 !== null && !Number.isNaN(Number(signal.atr_14))
                  ? displayValue(Number(signal.atr_14))
                  : 'N/A';
              const volValue = formatOptionalPercent(signal.volatility_14, 2);

              const reasoningItems = Array.isArray(signal.reasoning)
                  ? signal.reasoning.map((item) => {
                      const featureLabel = formatLabel(item.feature || 'Feature');
                      const directionLabel = formatLabel(item.direction || 'Neutral');
                      const weightLabel = formatOptionalPercent(item.weight || 0, 1);
                      const valueLabel = formatMetric(item.value || 0, 4);
                      return `<li><strong>${featureLabel}</strong> (${directionLabel}) • weight ${weightLabel}, value ${valueLabel}</li>`;
                  })
                  : [];

              const reasoningHtml = reasoningItems.length
                  ? `<div><strong>Top Drivers:</strong><ul class="ai-reasoning-list">${reasoningItems.join('')}</ul></div>`
                  : '<div class="ai-trading-note">Model factors were balanced; no dominant drivers surfaced.</div>';

              const backtest = aiTrading.backtest || {};
              const backtestItems = [
                  `<li><strong>Trades:</strong> ${formatMetric(backtest.trades || 0, 0)}</li>`,
                  `<li><strong>Hit Rate:</strong> ${formatOptionalPercent(backtest.hit_rate || 0, 1)}</li>`,
                  `<li><strong>Strategy Return:</strong> ${formatOptionalPercent(backtest.strategy_return || 0, 2)}</li>`,
                  `<li><strong>Buy & Hold:</strong> ${formatOptionalPercent(backtest.buy_hold_return || 0, 2)}</li>`,
                  `<li><strong>Max Drawdown:</strong> ${formatOptionalPercent(backtest.max_drawdown || 0, 2)}</li>`,
                  `<li><strong>Avg Trade Return:</strong> ${formatOptionalPercent(backtest.avg_trade_return || 0, 2)}</li>`
              ];

              const lastSignals = Array.isArray(backtest.last_signals)
                  ? backtest.last_signals.map((item) => {
                      const actionText = formatLabel(item.signal || 'Hold');
                      const probText = formatOptionalPercent(item.probability || 0, 1);
                      const retText = formatOptionalPercent(item.next_day_return || 0, 2);
                      return `<li>${item.date || 'Recent'} • ${actionText} @ ${probText}, realised ${retText}</li>`;
                  })
                  : [];

              const lastSignalsHtml = lastSignals.length
                  ? `<div><strong>Recent Trades:</strong><ul class="ai-backtest-list">${lastSignals.join('')}</ul></div>`
                  : '';

              const model = aiTrading.model_summary || {};
              const featureCount = Array.isArray(model.feature_columns) ? model.feature_columns.length : 0;

              const metricsGrid = `
                  <div class="ai-trading-grid">
                      <div class="ai-trading-metric">
                          <span>Probability ⬆︎ / ⬇︎</span>
                          <strong>${probabilityUp} / ${probabilityDown}</strong>
                      </div>
                      <div class="ai-trading-metric">
                          <span>Signal Confidence</span>
                          <strong>${confidence}</strong>
                      </div>
                      <div class="ai-trading-metric">
                          <span>Expected Daily Edge</span>
                          <strong>${expectedReturn}</strong>
                      </div>
                      <div class="ai-trading-metric">
                          <span>Suggested Position</span>
                          <strong>${positionSize}</strong>
                      </div>
                      <div class="ai-trading-metric">
                          <span>Stop / Target</span>
                          <strong>${stopLoss} → ${takeProfit}</strong>
                      </div>
                      <div class="ai-trading-metric">
                          <span>ATR / Volatility</span>
                          <strong>${atrValue} • ${volValue}</strong>
                      </div>
                  </div>
              `;

              const modelSummary = `
                  <div class="ai-trading-note">
                      Model trained on ${formatMetric(model.training_rows || 0, 0)} samples, evaluated on ${formatMetric(model.evaluation_rows || 0, 0)}.
                      Accuracies — train: ${formatOptionalPercent(model.train_accuracy || 0, 1)}, eval: ${formatOptionalPercent(model.evaluation_accuracy || 0, 1)}.
                      Features used: ${featureCount}.
                  </div>
              `;

              return `
                  <section>
                      <h3 class="section-title">AI Trading Strategy</h3>
                      <div class="highlight-card ai-trading-card">
                          <span class="ai-action-badge ${actionRaw}">${actionLabel}</span>
                          ${metricsGrid}
                          ${reasoningHtml}
                          <div>
                              <strong>Backtest (${formatMetric(backtest.evaluation_window || 0, 0)} sessions)</strong>
                              <ul class="ai-backtest-list">
                                  ${backtestItems.join('')}
                              </ul>
                              ${lastSignalsHtml}
                          </div>
                          ${modelSummary}
                      </div>
                  </section>
              `;
          }

        async function handleLogout() {
            try {
                await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'same-origin'
                });
            } catch (error) {
                console.error('Logout error:', error);
            } finally {
                window.location.href = '/';
            }
        }

        async function getForecast() {
            clearFormMessage();
            const marketCountry = document.getElementById('marketCountry').value;
            const imageFile = document.getElementById('chartImage').files[0];
            const assetType = assetTypeSelect.value || 'equity';

            let ticker = tickerInput.value.trim().toUpperCase();
            if (!ticker) {
                const fromSearch = companySearchInput.value.trim();
                const match = fromSearch.match(/\(([^)]+)\)$/);
                if (match && match[1]) {
                    ticker = match[1].toUpperCase();
                    tickerInput.value = ticker;
                }
            }

            if (!ticker) {
                showFormMessage('Please choose a company from search results or enter a ticker symbol.', 'error');
                resultDiv.style.display = 'none';
                return;
            }

            const formData = new FormData();
            formData.append('ticker', ticker);
            formData.append('market_country', marketCountry);
            formData.append('asset_type', assetType);
            if (toggleMacro) {
                formData.append('enable_macro', toggleMacro.checked ? 'true' : 'false');
            }
            if (toggleNews) {
                formData.append('enable_news', toggleNews.checked ? 'true' : 'false');
            }
            if (toggleFundamental) {
                formData.append('enable_fundamental', toggleFundamental.checked ? 'true' : 'false');
            }
            if (toggleCandlestick) {
                formData.append('enable_candlestick', toggleCandlestick.checked ? 'true' : 'false');
            }
            if (imageFile) {
                formData.append('chartImage', imageFile);
            }

            resultDiv.style.display = 'none';
            loader.style.display = 'block';

            try {
                const response = await fetch('/forecast_with_image', {
                    method: 'POST',
                    body: formData
                });

                loader.style.display = 'none';
                resultDiv.style.display = 'block';

                if (response.status === 401) {
                    window.location.href = '/';
                    return;
                }

                if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error ? errorData.error : 'Server error, please check logs.';
                    } catch (e) {
                        const errorText = await response.text();
                        errorMessage = errorText ? errorText.substring(0, 300) : 'Server error, response not JSON.';
                    }
                    showFormMessage(errorMessage, 'error');
                    return;
                }

                clearFormMessage();
                const data = await response.json();
                const candlestickSummary = data.candlestick_patterns || {};
                const hasCandlestickFeature = Boolean(data.feature_flags && data.feature_flags.candlestick);

                let imageSentimentMeta = '';
                if (data.image_analysis_sentiment && data.image_analysis_sentiment !== 'Not Provided') {
                    imageSentimentMeta = `<span class="meta-item"><strong>Chart Image Sentiment:</strong> ${data.image_analysis_sentiment}</span>`;
                }

                let threeDayForecastHtml = '<section><h3 class="section-title">Next 3 Trading Days</h3>';
                if (data.three_day_forecast && data.three_day_forecast.length > 0) {
                    data.three_day_forecast.forEach((dayForecast) => {
                        let recClass = 'neutral';
                        const recommendation = (dayForecast.recommendation || '').toLowerCase();
                        if (recommendation.includes('buy')) recClass = 'buy';
                        if (recommendation.includes('sell')) recClass = 'sell';

                        threeDayForecastHtml += `
                            <div class="daily-forecast-day">
                                <h4>${dayForecast.date || 'N/A'}</h4>
                                <p><strong>Predicted Price:</strong> ${displayValue(dayForecast.price)}</p>
                                <p><em>Confidence Interval:</em> ${displayValue(dayForecast.lower_bound)} - ${displayValue(dayForecast.upper_bound)}</p>
                                <p><strong>Recommendation:</strong> <span class="recommendation ${recClass}">${dayForecast.recommendation || 'N/A'}</span></p>
                            </div>
                        `;
                    });
                } else {
                    threeDayForecastHtml += '<p class="helper-text">Daily forecast data not available.</p>';
                }
                threeDayForecastHtml += '</section>';

                let weekAheadForecastHtml = '<section><h3 class="section-title">Week Ahead Forecast</h3>';
                if (data.forecast_week_ahead && data.forecast_week_ahead.price !== 'N/A') {
                    let weekRecClass = 'neutral';
                    const weekRec = (data.forecast_week_ahead.recommendation || '').toLowerCase();
                    if (weekRec.includes('buy')) weekRecClass = 'buy';
                    if (weekRec.includes('sell')) weekRecClass = 'sell';
                    weekAheadForecastHtml += `
                        <div class="highlight-card">
                            <p><strong>Target Date:</strong> ${data.forecast_week_ahead.date || 'N/A'}</p>
                            <p><strong>Predicted Price:</strong> ${displayValue(data.forecast_week_ahead.price)}</p>
                            <p><em>Confidence Interval:</em> ${displayValue(data.forecast_week_ahead.lower_bound)} - ${displayValue(data.forecast_week_ahead.upper_bound)}</p>
                            <p><strong>Recommendation:</strong> <span class="recommendation ${weekRecClass}">${data.forecast_week_ahead.recommendation || 'N/A'}</span></p>
                        </div>
                    `;
                } else {
                    weekAheadForecastHtml += '<p class="helper-text">Week ahead forecast data not available.</p>';
                }
                weekAheadForecastHtml += '</section>';

                  let candlestickHtml = '';
                  const biasLabel = typeof candlestickSummary.bias === 'string' ? formatLabel(candlestickSummary.bias) : '';
                  const candlestickSummaryItems = [];
                  if (biasLabel) {
                      candlestickSummaryItems.push(`<li><strong>Bias:</strong> ${biasLabel}</li>`);
                  }
                  if (candlestickSummary.net_score !== undefined && candlestickSummary.net_score !== null) {
                      candlestickSummaryItems.push(`<li><strong>Net Score (5-day):</strong> ${formatMetric(candlestickSummary.net_score, 2)}</li>`);
                  }
                  if (candlestickSummary.bullish_score !== undefined && candlestickSummary.bullish_score !== null) {
                      candlestickSummaryItems.push(`<li><strong>Bullish Score:</strong> ${formatMetric(candlestickSummary.bullish_score, 2)}</li>`);
                  }
                  if (candlestickSummary.bearish_score !== undefined && candlestickSummary.bearish_score !== null) {
                      candlestickSummaryItems.push(`<li><strong>Bearish Score:</strong> ${formatMetric(candlestickSummary.bearish_score, 2)}</li>`);
                  }
                  if (candlestickSummary.continuation_score !== undefined && candlestickSummary.continuation_score !== null) {
                      candlestickSummaryItems.push(`<li><strong>Continuation Score:</strong> ${formatMetric(candlestickSummary.continuation_score, 2)}</li>`);
                  }
                  const candlestickSummaryList = candlestickSummaryItems.length ? `<ul>${candlestickSummaryItems.join('')}</ul>` : '';
                  const candlestickSignals = Array.isArray(candlestickSummary.recent_signals)
                      ? candlestickSummary.recent_signals.slice(-5).reverse()
                      : [];
                  let candlestickSignalsHtml = '';
                  if (candlestickSignals.length > 0) {
                      const signalItems = candlestickSignals.map((signal) => {
                          const patternName = signal.pattern || 'Pattern';
                          const signalDate = signal.date || 'N/A';
                          const signalType = signal.type ? formatLabel(signal.type) : 'N/A';
                          const weightValue = signal.weight !== undefined && signal.weight !== null
                              ? formatMetric(signal.weight, 2)
                              : 'N/A';
                          return `<li><strong>${patternName}</strong> on ${signalDate} (${signalType}, weight ${weightValue})</li>`;
                      }).join('');
                      candlestickSignalsHtml = `<div><strong>Recent Signals:</strong><ul>${signalItems}</ul></div>`;
                  }
                  if (candlestickSummaryList || candlestickSignalsHtml || hasCandlestickFeature) {
                      candlestickHtml = `
                          <section>
                              <h3 class="section-title">Candlestick Pattern Insight</h3>
                              <div class="highlight-card">
                                  ${candlestickSummaryList || '<p class="helper-text">No candlestick summary available.</p>'}
                                  ${candlestickSignalsHtml}
                              </div>
                          </section>
                      `;
                  }

                const priceDiagnostics = data.price_diagnostics || {};
                let priceDiagnosticsHtml = '';
                if (Object.keys(priceDiagnostics).length > 0) {
                    priceDiagnosticsHtml = `
                        <section>
                            <h3 class="section-title">Price Diagnostics</h3>
                            <div class="highlight-card">
                                <ul>
                                    <li><strong>Latest Close:</strong> ${displayValue(priceDiagnostics.latest_close)}</li>
                                    <li><strong>Daily Volatility:</strong> ${formatPercentFromDecimal(priceDiagnostics.daily_volatility)}</li>
                                    <li><strong>1-Month Return:</strong> ${formatPercentFromDecimal(priceDiagnostics.monthly_return)}</li>
                                    <li><strong>1-Quarter Return:</strong> ${formatPercentFromDecimal(priceDiagnostics.quarter_return)}</li>
                                    <li><strong>5th Percentile Price:</strong> ${displayValue(priceDiagnostics.fifth_percentile)}</li>
                                    <li><strong>95th Percentile Price:</strong> ${displayValue(priceDiagnostics.ninety_fifth_percentile)}</li>
                                </ul>
                            </div>
                        </section>
                    `;
                }

                const macroSnapshot = data.macro_snapshot || {};
                let macroSnapshotHtml = '';
                if (Object.keys(macroSnapshot).length > 0) {
                    const macroItems = Object.entries(macroSnapshot)
                        .map(([key, value]) => `<li><strong>${formatLabel(key)}:</strong> ${formatMetric(value)}</li>`)
                        .join('');
                    macroSnapshotHtml = `
                        <section>
                            <h3 class="section-title">Macro Environment Snapshot</h3>
                            <div class="highlight-card">
                                <ul>${macroItems}</ul>
                            </div>
                        </section>
                    `;
                }

                const fundamentals = data.fundamentals || {};
                let fundamentalsHtml = '';
                const fundamentalKeys = ['trailing_pe', 'forward_pe', 'peg_ratio', 'price_to_book', 'dividend_yield', 'market_cap', 'beta'];
                const fundamentalsList = fundamentalKeys
                    .filter((key) => fundamentals[key] !== undefined && fundamentals[key] !== null)
                    .map((key) => {
                        const formattedValue = key === 'dividend_yield'
                            ? formatPercentFromDecimal(fundamentals[key])
                            : formatMetric(fundamentals[key]);
                        return `<li><strong>${formatLabel(key)}:</strong> ${formattedValue}</li>`;
                    });
                if (fundamentalsList.length > 0) {
                    fundamentalsHtml = `
                        <section>
                            <h3 class="section-title">Fundamental Snapshot</h3>
                            <div class="highlight-card">
                                <ul>${fundamentalsList.join('')}</ul>
                            </div>
                        </section>
                    `;
                }

                const newsSummary = data.news_sentiment_summary || {};
                let newsSummaryHtml = '';
                if (Object.keys(newsSummary).length > 0) {
                    const summaryItems = Object.entries(newsSummary)
                        .map(([key, value]) => {
                            if (typeof value === 'number' && !Number.isNaN(value)) {
                                const isCount = key.toLowerCase().includes('count');
                                const formatted = isCount ? formatMetric(value, 0) : formatMetric(value, 3);
                                return `<li><strong>${formatLabel(key)}:</strong> ${formatted}</li>`;
                            }
                            return `<li><strong>${formatLabel(key)}:</strong> ${value}</li>`;
                        })
                        .join('');
                    newsSummaryHtml = `
                        <section>
                            <h3 class="section-title">News Sentiment Summary (7-day)</h3>
                            <div class="highlight-card">
                                <ul>${summaryItems}</ul>
                            </div>
                        </section>
                    `;
                }

                const newsHighlights = Array.isArray(data.news_highlights) ? data.news_highlights.slice(0, 5) : [];
                let newsHighlightsHtml = '';
                if (newsHighlights.length > 0) {
                    const highlightsList = newsHighlights
                        .map((item) => `
                            <li>
                                <strong>${item.headline || 'Untitled'}</strong>
                                <div>Published: ${formatDateTime(item.published)}</div>
                                <div>Sentiment: ${formatMetric(item.sentiment, 3)}</div>
                                <div>Categories: ${item.categories && item.categories.length ? item.categories.join(', ') : 'General'}</div>
                                ${item.url ? `<div><a href="${item.url}" target="_blank" rel="noopener">Read Article</a></div>` : ''}
                            </li>
                        `)
                        .join('');
                    newsHighlightsHtml = `
                        <section>
                            <h3 class="section-title">Latest Relevant News</h3>
                            <ul class="news-list">${highlightsList}</ul>
                        </section>
                    `;
                }

                const modelRegressors = Array.isArray(data.model_regressors) ? data.model_regressors : [];
                let modelRegressorsHtml = '';
                if (modelRegressors.length > 0) {
                    modelRegressorsHtml = `
                        <section>
                            <h3 class="section-title">Model Feature Inputs</h3>
                            <div class="highlight-card">
                                <p>Prophet regressors considered in this forecast:</p>
                                <p>${modelRegressors.map(formatLabel).join(', ')}</p>
                            </div>
                        </section>
                    `;
                }

                const featureFlags = data.feature_flags || {};
                const featureFlagsRequested = data.feature_flags_requested || {};
                const featureFlagNotes = data.feature_flag_notes || {};
                const featureFlagKeys = ['macro', 'news', 'candlestick'].filter((key) =>
                    Object.prototype.hasOwnProperty.call(featureFlags, key) ||
                    Object.prototype.hasOwnProperty.call(featureFlagsRequested, key) ||
                    Object.prototype.hasOwnProperty.call(featureFlagNotes, key)
                );
                let featureFlagsHtml = '';
                if (featureFlagKeys.length > 0) {
                    const featureFlagRows = featureFlagKeys.map((key) => {
                        const label = FEATURE_FLAG_LABELS[key] || formatLabel(key);
                        const requestedValue = featureFlagsRequested[key];
                        const hasRequested = typeof requestedValue === 'boolean';
                        const requestedText = hasRequested ? (requestedValue ? 'Yes' : 'No') : '—';
                        const requestedClass = hasRequested ? (requestedValue ? 'on' : 'off') : 'neutral';
                        const activatedValue = Boolean(featureFlags[key]);
                        const activatedText = activatedValue ? 'Yes' : 'No';
                        const activatedClass = activatedValue ? 'on' : 'off';
                        const note = featureFlagNotes[key] || '';
                        return `
                            <div class="feature-flag-row">
                                <div class="feature-flag-row-header">
                                    <span class="feature-flag-name">${label}</span>
                                    <div class="feature-flag-pills">
                                        <span class="feature-flag-chip ${requestedClass}">Requested: ${requestedText}</span>
                                        <span class="feature-flag-chip ${activatedClass}">Activated: ${activatedText}</span>
                                    </div>
                                </div>
                                ${note ? `<div class="feature-flag-note">${note}</div>` : ''}
                            </div>
                        `;
                    }).join('');
                    featureFlagsHtml = `
                        <section>
                            <h3 class="section-title">Feature Flag Status</h3>
                            <div class="highlight-card feature-flag-status">
                                ${featureFlagRows}
                            </div>
                        </section>
                    `;
                  }
                  const dashboardsHtml = renderDashboards(data.stock_dashboards);
                  const aiTradingHtml = renderAITradingSection(data.ai_trading);
                  const metaItems = [
                      `<span class="meta-item"><strong>Current Price:</strong> ${displayValue(data.current_price)}</span>`,
                      `<span class="meta-item"><strong>As of:</strong> ${formatDateTime(data.last_known_date)}</span>`
                  ];
                  if (data.asset_type) {
                      metaItems.push(`<span class="meta-item"><strong>Asset Type:</strong> ${formatLabel(data.asset_type)}</span>`);
                  }
                  if (candlestickSummary.bias && typeof candlestickSummary.bias === 'string' && candlestickSummary.bias.toLowerCase() !== 'neutral') {
                      metaItems.push(`<span class="meta-item"><strong>Candlestick Bias:</strong> ${formatLabel(candlestickSummary.bias)}</span>`);
                  }
                  if (imageSentimentMeta) {
                      metaItems.push(imageSentimentMeta);
                  }
                  const metaHtml = `<div class="forecast-meta">${metaItems.join('')}</div>`;

                  resultDiv.innerHTML = `
                      <h2>Forecast Summary for ${data.ticker || 'N/A'}</h2>
                      ${metaHtml}
                      ${aiTradingHtml}
                      ${dashboardsHtml}
                      ${featureFlagsHtml}
                      ${candlestickHtml}
                      ${threeDayForecastHtml}
                      ${weekAheadForecastHtml}
                      ${priceDiagnosticsHtml}
                      ${macroSnapshotHtml}
                      ${fundamentalsHtml}
                      ${newsSummaryHtml}
                      ${newsHighlightsHtml}
                      ${modelRegressorsHtml}
                  `;
            } catch (error) {
                loader.style.display = 'none';
                resultDiv.style.display = 'none';
                showFormMessage(`Error: ${error.message}`, 'error');
                console.error('Error fetching forecast:', error);
            }
        }
    </script>
</body>
</html>
